{% extends 'base4.html' %}
{% load custom_filters %}

{% block content %}
<div class="container my-5">
    <!-- Messages Section -->
    {% if messages %}
    <div class="row mb-4">
        <div class="col-md-12">
            {% for message in messages %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Left Column - Pet Details -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Adoption Details</h5>
                </div>
                <div class="card-body">
                    <h4 class="text-center mb-3">{{ adoption.pet.name }}</h4>
                    <div class="info-group mb-3">
                        <p class="mb-2"><i class="fas fa-tag mr-2"></i> <strong>Status:</strong> 
                            <span class="badge badge-success">{{ adoption.adoption_status }}</span>
                        </p>
                        <p class="mb-2"><i class="far fa-calendar-alt mr-2"></i> <strong>Request Date:</strong> {{ adopter.request_date }}</p>
                        <p class="mb-2"><i class="fas fa-user mr-2"></i> <strong>Adopted by:</strong> {{ adopter.first_name }} {{ adopter.last_name }}</p>
                    </div>
                    <div class="info-group">
                        <p class="mb-2"><strong>Additional Details:</strong></p>
                        <p class="text-muted">{{ adoption.additional_details|default:"No additional details provided." }}</p>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'adopted_history' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left mr-1"></i> Back
                        </a>
                        <button class="btn btn-primary view-reports" data-toggle="modal" data-target="#composeModal">
                            <i class="fas fa-paper-plane mr-1"></i> Request Reports
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Tracking Information -->
        <div class="col-md-8">
            <!-- Tracking Period Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Tracking Period</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if tracking_period %}
                        <div class="col-md-6">
                            <div class="tracking-date">
                                <h6><i class="fas fa-play mr-2"></i> Start Date</h6>
                                <p class="lead">{{ tracking_period.0 }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="tracking-date">
                                <h6><i class="fas fa-flag-checkered mr-2"></i> End Date</h6>
                                <p class="lead">{{ tracking_period.1 }}</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center py-3">
                            <p class="text-muted mb-0">No tracking period available.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Calendar Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Track Updates</h5>
                </div>
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Report Details -->
<div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="reportModalLabel">Report Details</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4" id="reportModalBody">
                <!-- Report details will be loaded here with proper structure -->
                <div class="report-content">
                    <!-- Content will be inserted here by AJAX -->
                </div>
            </div>
            <div class="modal-footer">
                <a href="{% url 'adopted_history' %}" class="btn btn-secondary mr-2">
                    <i class="fas fa-arrow-left mr-1"></i> Back to Adopted History
                </a>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Compose Message -->
<div class="modal fade" id="composeModal" tabindex="-1" role="dialog" aria-labelledby="composeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="composeModalLabel">Request for Reports</h5>
                
            </div>
        
                <form id="messageForm">
                    <div class="form-group">
                        <label for="recipient_id"><i class="fas fa-id-badge mr-1"></i> Recipient ID:</label>
                        <input type="text" class="form-control bg-light" id="recipient_id" value="{{ adoper.user_id }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="recipient"><i class="fas fa-user mr-1"></i> Recipient Name:</label>
                        <input type="text" class="form-control bg-light" id="recipient" value="{{ adopter.first_name }} {{ adopter.last_name }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="message"><i class="fas fa-envelope mr-1"></i> Message:</label>
                        <textarea class="form-control" id="message" rows="4" placeholder="Type your message here..."></textarea>
                    </div>
                </form>
         
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" id="sendMessageBtn">
                    <i class="fas fa-paper-plane mr-1"></i> Send Message
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* General Styles */
    body {
        background-color: #f8f9fa;
    }
    
    .card {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .card-header {
        border-radius: 0.5rem 0.5rem 0 0;
    }
    
    /* Calendar Styles */
    #calendar {
        margin: 0 auto;
        background-color: #fff;
        border-radius: 0.25rem;
    }
    
    .fc-event {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        border: none;
        margin-bottom: 2px;
    }
    
    .fc-day-grid-event {
        cursor: pointer;
    }
    
    .event-color-1 {
        background-color: #28a745;
        color: #fff;
    }
    
    .event-color-2 {
        background-color: #17a2b8;
        color: #fff;
    }
    
    .event-color-3 {
        background-color: #fd7e14;
        color: #fff;
    }
    
    /* Modal Styles */
    .modal-backdrop {
        z-index: 1040;
    }
    
    .modal {
        z-index: 1050;
    }
    
    .modal-content {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        border-radius: 0.5rem 0.5rem 0 0;
    }
    
    .tracking-date {
        padding: 0.75rem;
        border-radius: 0.25rem;
        background-color: #f8f9fa;
    }
    
    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .card {
            margin-bottom: 1.5rem;
        }
    }
    
</style>

<script>
    $(document).ready(function() {
        // Initialize the calendar
        $('#calendar').fullCalendar({
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            height: 500,
            themeSystem: 'bootstrap4',
            events: [
            {% if track_updates %}
            {% for update in track_updates %}
                {
                    title: '{{ update.notes }}',
                    start: '{{ update.followup_date }}',
                    url: "{% url 'admin_report_detail' update.id %}",
                    className: 'event-color-{{ forloop.counter0|divisibleby:3|yesno:"3,1,2" }}'
                },
            {% endfor %}
            {% endif %}
            ],
            eventClick: function(event) {
                if (event.url) {
                    $.ajax({
                        url: event.url,
                        type: 'GET',
                        beforeSend: function() {
                            $('#reportModalBody').html('Loading report details...');
                            $('#reportModal').modal('show');
                        },
                        success: function(data) {
                            if (data) {
                                $('#reportModalBody').html(data);
                            } else {
                                $('#reportModalBody').html('<div class="alert alert-info">No details available for this report.</div>');
                            }
                        },
                        error: function() {
                            $('#reportModalBody').html('<div class="alert alert-danger">Error fetching report details. Please try again.</div>');
                        }
                    });
                    return false;
                }
            }
        });

        // Handle the modal show event
        $('.view-reports').on('click', function() {
            $('#composeModal').modal('show');
        });

        // Handle the form submission
        $('#sendMessageBtn').on('click', function() {
            var recipientId = $('#recipient_id').val();
            var message = $('#message').val();
            
            if (!message.trim()) {
                alert('Please enter a message before sending.');
                return;
            }
            
            $.ajax({
                url: '{% url "send_notification" %}',
                type: 'POST',
                data: {
                    recipient_id: recipientId,
                    message: message
                },
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                beforeSend: function() {
                    $('#sendMessageBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...');
                },
                success: function(data) {
                    if (data.success) {
                        $('#composeModal').modal('hide');
                        
                        // Show success message
                        $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                          'Message sent successfully!' +
                          '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                          '<span aria-hidden="true">&times;</span></button></div>')
                          .insertAfter('nav.breadcrumb')
                          .delay(3000)
                          .fadeOut(function() {
                              $(this).remove();
                          });
                        
                        // Reset the form
                        $('#message').val('');
                    } else {
                        alert('Error sending message: ' + (data.error || 'Unknown error'));
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'Error sending message. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    alert(errorMsg);
                },
                complete: function() {
                    $('#sendMessageBtn').prop('disabled', false).html('<i class="fas fa-paper-plane mr-1"></i> Send Message');
                }
            });
        });
    });
</script>
{% endblock %}